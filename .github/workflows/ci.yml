# .github/workflows/ci.yml
# ===================================================
# Pipeline CI/CD GitHub Actions
# ===================================================
# Ce pipeline exécute les tests unitaires et les analyses de sécurité
# Il s'exécute sur les push/PR vers main et develop

name: CI/CD Pipeline

# ===================================================
# Déclencheurs du pipeline
# ===================================================
on:
  # Exécution sur push vers les branches principales
  push:
    branches: [ main, develop ]

  # Exécution sur les pull requests vers main
  pull_request:
    branches: [ main ]

  # Permet le déclenchement manuel depuis l'interface GitHub
  workflow_dispatch:

# ===================================================
# Variables d'environnement globales
# ===================================================
env:
  PYTHON_VERSION: "3.12"
  PYTHONUNBUFFERED: "1"

# ===================================================
# JOBS DU PIPELINE
# ===================================================
jobs:
  # ============================================
  # JOB 1 : Tests unitaires avec couverture
  # ============================================
  # Exécute pytest avec calcul de la couverture de code
  # Génère des rapports JUnit et Cobertura
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      # Récupère le code source du repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Installe uv avec cache basé sur uv.lock
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # Installe les dépendances core + dev (PAS le groupe ml)
      - name: Install dependencies
        run: uv sync --locked --group dev

      # Exécute les tests avec pytest et génère les rapports de couverture
      - name: Run unit tests with coverage
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          ENVIRONMENT: test
        run: |
          mkdir -p reports
          uv run pytest -v --tb=short \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=html:reports/htmlcov \
            --cov-report=term

      # Upload optionnel vers Codecov pour visualisation
      - name: Upload coverage to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          files: reports/coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

      # Conserve les rapports de test comme artifacts (7 jours)
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/
          retention-days: 7

  # ============================================
  # JOB 2 : Tests d'intégration
  # ============================================
  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --locked --group dev

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          ENVIRONMENT: test
        run: |
          mkdir -p reports
          uv run pytest -v tests/integration \
            --junitxml=reports/integration-junit.xml \
            --cov=src \
            --cov-append \
            --cov-report=xml:reports/integration-coverage.xml \
            --cov-report=html:reports/htmlcov

      # Upload optionnel vers Codecov pour visualisation
      - name: Upload coverage to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          files: reports/integration-coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

      # Conserve les rapports de test comme artifacts (7 jours)
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: reports/
          retention-days: 7

  # ============================================
  # JOB 3 : Analyse de sécurité Bandit
  # ============================================
  # Scanne le code Python à la recherche de vulnérabilités de sécurité
  security-bandit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Installe et exécute Bandit via uv tool
      - name: Run Bandit security scan
        run: |
          mkdir -p security-reports
          uvx bandit[toml] -r src -f json -o security-reports/bandit-report.json || true

      # Sauvegarde le rapport JSON pour consultation ultérieure
      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: security-reports/bandit-report.json
          retention-days: 7

  # ============================================
  # JOB 4 : Analyse des dépendances avec Safety
  # ============================================
  # Vérifie les vulnérabilités connues dans les dépendances
  security-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Exporte les dépendances depuis le lock file pour les scanners
      - name: Export dependencies
        run: |
          uv export --no-hashes --no-header --frozen > /tmp/requirements-export.txt

      # Safety : vérifie les vulnérabilités connues (base de données PyUp)
      - name: Run Safety scan
        run: |
          mkdir -p security-reports
          uvx safety check \
            -r /tmp/requirements-export.txt \
            --output json > security-reports/safety-report.json || true

      # pip-audit : vérifie les vulnérabilités (base OSV)
      - name: Run pip-audit scan
        run: |
          uvx pip-audit \
            -r /tmp/requirements-export.txt \
            -f json \
            -o security-reports/pip-audit.json || true

      # Conserve les rapports des deux outils
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: security-reports/
          retention-days: 7

  # ============================================
  # JOB 5 : OWASP Dependency-Check
  # ============================================
  # Analyse complète des dépendances avec la base OWASP NVD
  security-owasp:
    runs-on: ubuntu-latest

    # Utilise le container Docker officiel OWASP
    container:
      image: owasp/dependency-check-action:latest
      options: --user root

    # Configuration JVM pour optimiser les performances
    env:
      _JAVA_OPTIONS: "-Xmx2g -Xms256m -XX:MaxMetaspaceSize=256m -XX:+UseG1GC -XX:+UseStringDeduplication"
      JAVA_OPTS: "-Xmx2g"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Exécute OWASP Dependency-Check avec exclusions des dossiers inutiles
      - name: Run OWASP Dependency-Check
        run: |
          mkdir -p security-reports/dependency-check
          /usr/share/dependency-check/bin/dependency-check.sh \
            --project "chatbot-api" \
            --scan . \
            --format HTML \
            --format JSON \
            --format XML \
            --out security-reports/dependency-check \
            --noupdate \
            --enableExperimental \
            --exclude "**/node_modules/**" \
            --exclude "**/tests/**" \
            --exclude "**/test/**" \
            --exclude "**/__pycache__/**" \
            --exclude "**/.git/**" \
            --exclude "**/.pytest_cache/**" \
            --exclude "**/*.pyc" \
            --exclude "**/htmlcov/**" \
            --exclude "**/.cache/**" \
            --exclude "**/reports/**" \
            --exclude "**/security-reports/**" \
            --exclude "**/dist/**" \
            --exclude "**/build/**" \
            --failOnCVSS 7 || true

      # Vérifie que les rapports ont bien été générés
      - name: Check reports generated
        if: always()
        run: |
          ls -lh security-reports/dependency-check/ || true
          if [ -f "security-reports/dependency-check/dependency-check-report.json" ]; then
            echo "Reports generated successfully"
          else
            echo "Reports not found"
          fi

      # Conserve les rapports HTML, JSON et XML pour consultation
      - name: Upload OWASP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check
          path: security-reports/dependency-check/
          retention-days: 7

  # ============================================
  # JOB 6 : Validation finale
  # ============================================
  # Job récapitulatif qui s'exécute seulement si tous les jobs précédents réussissent
  build-success:
    runs-on: ubuntu-latest

    # Attend la fin de tous les autres jobs
    needs: [unit-tests, integration-tests, security-bandit, security-dependencies, security-owasp]

    # S'exécute uniquement si tous les jobs précédents ont réussi
    if: success()

    steps:
      - name: Build successful
        run: echo "All checks passed successfully"
