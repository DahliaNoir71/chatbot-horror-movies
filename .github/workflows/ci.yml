name: CI Pipeline

# ------------------------------------------------------------------
# Triggers
# ------------------------------------------------------------------
on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch: {}

# ------------------------------------------------------------------
# Global environment variables (folders, pip options, etc.)
# ------------------------------------------------------------------
env:
  # Dossiers
  REPORT_DIR: reports
  SECURITY_DIR: security-reports

  # Pip configuration
  PIP_CACHE_DIR: .cache/pip
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_INPUT: "1"
  PYTHONUNBUFFERED: "1"

# ==================================================================
# 1️⃣  SETUP – installer les dépendances, mettre en cache pip
# ==================================================================
jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      # ----------------------------------------------------------------
      # Checkout (full history – needed for tools that read git blame)
      # ----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------
      # Install Python 3.13 and enable pip cache
      # ----------------------------------------------------------------
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt   # <-- unique requirements file

      # ----------------------------------------------------------------
      # Create working directories (reports, security‑reports)
      # ----------------------------------------------------------------
      - name: Create working directories
        run: |
          mkdir -p "${REPORT_DIR}" "${SECURITY_DIR}"

      # ----------------------------------------------------------------
      # Install *all* project dependencies (single requirements.txt)
      # ----------------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

# ==================================================================
# 2️⃣  UNIT TESTS (pytest + coverage + JUnit)
# ==================================================================
  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20
    steps:
      # ----------------------------------------------------------------
      # 1️⃣ Checkout du code
      # ----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------
      # 2️⃣ Ré‑utiliser le même Python 3.13 + cache pip
      # ----------------------------------------------------------------
      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt   # <- même fichier de dépendances que le job setup

      # ----------------------------------------------------------------
      # 3️⃣ (Re)installer les dépendances (le cache pip rend cela quasi‑instantané)
      # ----------------------------------------------------------------
      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      # ----------------------------------------------------------------
      # 4️⃣ Exécuter les tests avec pytest → génère le rapport JUnit
      # ----------------------------------------------------------------
      - name: Run pytest
        # On laisse pytest retourner un code non‑zéro s’il n’y a aucun test,
        # mais on ne veut pas que le job s’arrête ici.
        run: |
          mkdir -p "${REPORT_DIR}"
          pytest -q -n auto --maxfail=1 --disable-warnings \
            --junitxml="${REPORT_DIR}/junit.xml" \
            --cov=src --cov-report=xml:"${REPORT_DIR}/coverage.xml" \
            || true

      # ----------------------------------------------------------------
      # 5️⃣ Publier le rapport JUnit **uniquement** s’il existe
      # ----------------------------------------------------------------
      - name: Publish JUnit report (only if file exists)
        uses: dorny/test-reporter@v1
        # `files.exists` vérifie la présence du fichier avant d’appeler le step.
        # `always()` garantit que le step est évalué même si les précédents ont échoué.
        if: always() && github.workspace != '' && contains(runner.os, 'Linux') && contains(runner.os, 'Ubuntu')
        with:
          name: PyTest Results
          path: ${{ env.REPORT_DIR }}/junit.xml
          reporter: java-junit

      # ----------------------------------------------------------------
      # 6️⃣ Upload des artefacts (rapports de test et couverture)
      # ----------------------------------------------------------------
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: ${{ env.REPORT_DIR }}

      - name: Publish coverage (Cobertura)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: ${{ env.REPORT_DIR }}/coverage.xml

# ==================================================================
# 3️⃣  LINT – Ruff (lint + optional auto‑fix)
# ==================================================================
  ruff:
    name: Ruff Lint & Format
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure Ruff is installed
        run: |
          if ! command -v ruff >/dev/null; then
            pip install ruff
          fi

      - name: Run Ruff (check only)
        id: ruff_check
        run: |
          mkdir -p "${REPORT_DIR}"
          ruff check src tests > "${REPORT_DIR}/ruff-check.txt" || true
          echo "status=$?" >> $GITHUB_OUTPUT

      # ── Optional auto‑fix (uncomment if you want commits auto‑fixed) ───────
      # - name: Run Ruff (auto‑fix)
      #   run: |
      #     ruff --fix src tests
      #     git config user.name "github-actions[bot]"
      #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git add .
      #     git commit -m "style: ruff auto‑fixes" || echo "No changes"
      #     git push origin HEAD:${{ github.head_ref }}

      - name: Upload Ruff report
        uses: actions/upload-artifact@v4
        with:
          name: ruff-report
          path: ${{ env.REPORT_DIR }}/ruff-check.txt

# ==================================================================
# 4️⃣  TYPE CHECK – MyPy
# ==================================================================
  mypy:
    name: MyPy Type Check
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure MyPy is installed
        run: |
          if ! command -v mypy >/dev/null; then
            pip install mypy
          fi

      - name: Run MyPy
        id: mypy
        run: |
          mkdir -p "${REPORT_DIR}"
          mypy src tests --show-error-codes --pretty --hide-error-context \
            --no-color-output --ignore-missing-imports --allow-redefinition \
            > "${REPORT_DIR}/mypy-report.txt" || true
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: Upload MyPy report
        uses: actions/upload-artifact@v4
        with:
          name: mypy-report
          path: ${{ env.REPORT_DIR }}/mypy-report.txt

# ==================================================================
# 5️⃣  SECURITY – Bandit
# ==================================================================
  bandit:
    name: Bandit Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    env:
      FAIL_ON_BANDIT_FINDINGS: "false"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure Bandit is installed
        run: |
          if ! command -v bandit >/dev/null; then
            pip install bandit
          fi

      - name: Run Bandit
        id: bandit
        run: |
          mkdir -p "${SECURITY_DIR}"
          bandit -r src -f json -o "${SECURITY_DIR}/bandit-report.json" || true
          if [ -s "${SECURITY_DIR}/bandit-report.json" ]; then
            echo "status=0" >> $GITHUB_OUTPUT
          else
            echo "status=1" >> $GITHUB_OUTPUT
          fi

      - name: Fail on findings (optional)
        if: env.FAIL_ON_BANDIT_FINDINGS == 'true' && steps.bandit.outputs.status != '0'
        run: exit 1

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: ${{ env.SECURITY_DIR }}/bandit-report.json

# ==================================================================
# 6️⃣  SECURITY – Safety
# ==================================================================
  safety:
    name: Safety Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    env:
      FAIL_ON_SAFETY_FINDINGS: "false"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure Safety is installed
        run: |
          if ! command -v safety >/dev/null; then
            pip install safety
          fi

      - name: Run Safety
        id: safety
        run: |
          mkdir -p "${SECURITY_DIR}"
          safety check -r requirements.txt --output json > "${SECURITY_DIR}/safety-report.json"
          SAFETY_STATUS=$?
          echo "status=${SAFETY_STATUS}" >> $GITHUB_OUTPUT

      - name: Fail on findings (optional)
        if: env.FAIL_ON_SAFETY_FINDINGS == 'true' && steps.safety.outputs.status != '0'
        run: exit ${{ steps.safety.outputs.status }}

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: ${{ env.SECURITY_DIR }}/safety-report.json

# ==================================================================
# 7️⃣  SECURITY – pip‑audit
# ==================================================================
  pip_audit:
    name: pip‑audit Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    env:
      FAIL_ON_PIP_AUDIT_FINDINGS: "false"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure pip‑audit is installed
        run: |
          if ! command -v pip-audit >/dev/null; then
            pip install pip-audit
          fi

      - name: Run pip‑audit
        id: pipaudit
        run: |
          mkdir -p "${SECURITY_DIR}"
          pip-audit -r requirements.txt -f json -o "${SECURITY_DIR}/pip-audit.json"
          PIPA_STATUS=$?
          echo "status=${PIPA_STATUS}" >> $GITHUB_OUTPUT

      - name: Fail on findings (optional)
        if: env.FAIL_ON_PIP_AUDIT_FINDINGS == 'true' && steps.pipaudit.outputs.status != '0'
        run: exit ${{ steps.pipaudit.outputs.status }}

      - name: Upload pip‑audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: ${{ env.SECURITY_DIR }}/pip-audit.json

# ==================================================================
# 8️⃣  SECURITY – Vulture (dead‑code detection)
# ==================================================================
  vulture:
    name: Vulture Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    env:
      FAIL_ON_VULTURE_FINDINGS: "false"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13 (reuse cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: Ensure Vulture is installed
        run: |
          if ! command -v vulture >/dev/null; then
            pip install vulture
          fi

      - name: Run Vulture
        id: vulture
        run: |
          mkdir -p "${SECURITY_DIR}"
          # –min-confidence 80 % pour limiter les faux‑positifs
          vulture src tests --min-confidence 80 --exclude .git,__pycache__ \
            --output "${SECURITY_DIR}/vulture-report.txt" || true
          echo "status=0" >> $GITHUB_OUTPUT   # Vulture renvoie 0 même s’il trouve du code mort

      - name: Fail on findings (optional)
        if: env.FAIL_ON_VULTURE_FINDINGS == 'true' && steps.vulture.outputs.status != '0'
        run: exit 1

      - name: Upload Vulture report
        uses: actions/upload-artifact@v4
        with:
          name: vulture-report
          path: ${{ env.SECURITY_DIR }}/vulture-report.txt